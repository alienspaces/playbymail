#!/usr/bin/env sh

# Safe npm Package Upgrade Tool
# Upgrades npm packages and runs security checks afterward
# Usage: ./tools/npm-upgrade-safe [package-name] [--frontend|--root]

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_status() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# Ensure we're in the project root
if [ -f "tools/npm-upgrade-safe" ]; then
    # Already in project root
    :
elif [ -f "../tools/npm-upgrade-safe" ]; then
    # In a subdirectory, go to project root
    cd ..
else
    print_error "Must be run from project root or a subdirectory"
    exit 1
fi

# Determine which package.json to use
TARGET_DIR=""
if [ "$2" = "--frontend" ] || [ "$1" = "--frontend" ]; then
    TARGET_DIR="frontend"
    PACKAGE_NAME="$1"
    if [ "$1" = "--frontend" ]; then
        PACKAGE_NAME="$3"
    fi
elif [ "$2" = "--root" ] || [ "$1" = "--root" ]; then
    TARGET_DIR="."
    PACKAGE_NAME="$1"
    if [ "$1" = "--root" ]; then
        PACKAGE_NAME="$3"
    fi
else
    # Default to frontend if it exists
    if [ -f "frontend/package.json" ]; then
        TARGET_DIR="frontend"
        PACKAGE_NAME="$1"
    else
        TARGET_DIR="."
        PACKAGE_NAME="$1"
    fi
fi

# Check if we're in the right directory
if [ ! -f "$TARGET_DIR/package.json" ]; then
    print_error "package.json not found in $TARGET_DIR"
    echo "Usage: ./tools/npm-upgrade-safe [package-name] [--frontend|--root]"
    exit 1
fi

# Use nvm if available and .nvmrc exists
if [ -f "$TARGET_DIR/.nvmrc" ]; then
    NVMRC_VERSION=$(cat "$TARGET_DIR/.nvmrc")
    if command -v nvm >/dev/null 2>&1; then
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
        nvm use "$NVMRC_VERSION" 2>/dev/null || nvm install "$NVMRC_VERSION"
    fi
fi

# Check if Node.js and npm are available
if ! command -v node >/dev/null 2>&1; then
    print_error "Node.js not found"
    exit 1
fi

if ! command -v npm >/dev/null 2>&1; then
    print_error "npm not found"
    exit 1
fi

# Change to target directory
cd "$TARGET_DIR" || exit 1

echo "ðŸ”’ Safe npm Package Upgrade"
echo "=========================="
echo ""
print_info "Target: $TARGET_DIR/package.json"
echo ""

# Backup package.json and package-lock.json
print_status "Creating backup of package files..."
cp package.json package.json.backup
if [ -f "package-lock.json" ]; then
    cp package-lock.json package-lock.json.backup
fi

# Upgrade packages
if [ -n "$PACKAGE_NAME" ]; then
    print_info "Upgrading package: $PACKAGE_NAME"
    npm install "$PACKAGE_NAME@latest" --save-exact
else
    print_info "Upgrading all packages to latest versions..."
    npm update --save-exact
fi

# Ensure exact versions (remove ^ and ~)
print_status "Ensuring exact versions (removing ^ and ~)..."
if command -v sed >/dev/null 2>&1; then
    # Remove ^ and ~ from version numbers in package.json
    sed -i.bak 's/"\([^"]*\)":\s*"[\^~]\([^"]*\)"/"\1": "\2"/g' package.json
    rm -f package.json.bak
fi

# Regenerate package-lock.json with exact versions
print_status "Regenerating package-lock.json with exact versions..."
npm install --package-lock-only

# Run security check
echo ""
echo "ðŸ”’ Running security check..."
echo "=========================="
cd .. || exit 1
if [ -f "tools/security-check" ]; then
    ./tools/security-check
    SECURITY_CHECK_EXIT=$?
else
    print_warning "security-check script not found, skipping..."
    SECURITY_CHECK_EXIT=0
fi

# Summary
echo ""
echo "=========================="
if [ $SECURITY_CHECK_EXIT -eq 0 ]; then
    print_status "Package upgrade completed successfully"
    echo ""
    print_info "Backup files created:"
    echo "  - $TARGET_DIR/package.json.backup"
    if [ -f "$TARGET_DIR/package-lock.json.backup" ]; then
        echo "  - $TARGET_DIR/package-lock.json.backup"
    fi
    echo ""
    print_info "You can remove backups with:"
    echo "  rm $TARGET_DIR/package.json.backup"
    if [ -f "$TARGET_DIR/package-lock.json.backup" ]; then
        echo "  rm $TARGET_DIR/package-lock.json.backup"
    fi
else
    print_error "Security check failed!"
    echo ""
    print_warning "Restoring backup files..."
    cd "$TARGET_DIR" || exit 1
    mv package.json.backup package.json
    if [ -f "package-lock.json.backup" ]; then
        mv package-lock.json.backup package-lock.json
    fi
    print_status "Backup files restored"
    echo ""
    print_error "Package upgrade aborted due to security concerns"
    exit 1
fi

