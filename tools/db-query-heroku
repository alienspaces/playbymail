#!/usr/bin/env sh

# db-query-heroku - Execute SQL queries against the Heroku database
# Usage: ./tools/db-query-heroku "SELECT * FROM table_name" [heroku-app-name]

set -e

APP_NAME=${2:-playbymail}

# Check if query is provided
if [ $# -eq 0 ]; then
    echo "Usage: ./tools/db-query-heroku \"SQL_QUERY\" [heroku-app-name]"
    echo "Example: ./tools/db-query-heroku \"SELECT * FROM game_instance_parameter\""
    echo "Example: ./tools/db-query-heroku \"SELECT COUNT(*) FROM game\" my-app-name"
    exit 1
fi

QUERY="$1"

# Check for required tools
if ! command -v heroku >/dev/null 2>&1; then
    echo "❌ Heroku CLI not found. Install with: curl https://cli-assets.heroku.com/install.sh | sh"
    exit 1
fi

if ! command -v psql >/dev/null 2>&1; then
    echo "❌ psql not found. Please install PostgreSQL client tools."
    exit 1
fi

# Get Heroku database URL
DATABASE_URL=$(heroku config:get DATABASE_URL --app "$APP_NAME")
if [ -z "$DATABASE_URL" ]; then
    echo "❌ Could not retrieve DATABASE_URL from Heroku for app '$APP_NAME'"
    exit 1
fi

echo "Executing query on Heroku database (app: $APP_NAME): $QUERY"
echo "----------------------------------------"

# Execute the query using psql
psql "$DATABASE_URL" -c "$QUERY"
