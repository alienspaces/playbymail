stages:
  - test
  - build
  - e2e
  - deploy

lint-backend:
  image: golangci/golangci-lint:v2.1.6-alpine
  stage: test
  interruptible: true
  script:
    - ./tools/golang-lint
  rules:
    - changes:
        - backend/**/*
        - tools/golang-lint

test-backend:
  variables:
    # Postgres variables for Gitlab CI postgres service
    POSTGRES_DB: playbymail
    POSTGRES_USER: user
    POSTGRES_PASSWORD: pass
    # Database URL for backend scripts and Go servers
    DATABASE_URL: "postgres://$POSTGRES_USER:$POSTGRES_PASSWORD@postgres:5432/$POSTGRES_DB?sslmode=disable"

    # Database variables for backend Go servers
    DATABASE_VERSION: 17.5
    DATABASE_MAX_OPEN_CONNECTIONS: "180"
    DATABASE_MAX_IDLE_CONNECTIONS: "45"
    DATABASE_MAX_IDLE_TIME_MINS: "15"

    # Environment variables for backend Go servers
    APP_ENV: develop
    APP_HOST: "https://www.playbymail.games"
    PORT: 8080
    LOG_LEVEL: info
    GO_VERSION: 1.24.5
    EMAILER_FAKED: "true"
    JOBCLIENT_MAX_WORKERS: "10"
    TOKEN_HMAC_KEY: "changeme-super-secret-key"
    TEMPLATES_PATH: "${CI_PROJECT_DIR}/backend/templates"
    SCHEMA_PATH: "${CI_PROJECT_DIR}/backend/schema"
  image: golang:1.24.5-alpine
  stage: test
  interruptible: true
  services:
    - name: postgres:17.5-alpine
      alias: postgres
  before_script:
    - apk add build-base
    - apk add git
    - apk add bash
    - apk add postgresql-client
    - apk add chromium
    - apk add chromium-chromedriver
    - export GOOGLE_CHROME_SHIM=/usr/bin/chromium-browser
  script:
    - ./tools/test-backend-ci
  artifacts:
    when: always
    paths:
      - backend/coverage-core.out
      - backend/coverage-internal.out
    expire_in: 30 days
  cache:
    key:
      files:
        - backend/go.sum
    paths:
      - /go/pkg/mod/
  rules:
    - changes:
        - backend/**/*
        - tools/**/*

test-frontend:
  image: node:18-alpine
  stage: test
  interruptible: true
  before_script:
    - apk add --no-cache git
  script:
    - ./tools/test-frontend
  rules:
    - changes:
        - frontend/**/*

build-frontend:
  image: node:18-alpine
  stage: build
  only:
    - main
  before_script:
    - apk add --no-cache git
  script:
    - cd frontend
    - npm install
    - node scripts/build-info.js
    - export VITE_COMMIT_REF=$(node -p "require('fs').readFileSync('.env.build', 'utf8').split('\n').find(line => line.startsWith('VITE_COMMIT_REF=')).split('=')[1]")
    - export VITE_BUILD_DATE=$(node -p "require('fs').readFileSync('.env.build', 'utf8').split('\n').find(line => line.startsWith('VITE_BUILD_DATE=')).split('=')[1]")
    - export VITE_BUILD_TIME=$(node -p "require('fs').readFileSync('.env.build', 'utf8').split('\n').find(line => line.startsWith('VITE_BUILD_TIME=')).split('=')[1]")
    - npm run build
  artifacts:
    paths:
      - frontend/dist

test-e2e:
  variables:
    TZ: "UTC"
    POSTGRES_DB: playbymail
    POSTGRES_USER: user
    POSTGRES_PASSWORD: pass
    DATABASE_URL: "postgres://$POSTGRES_USER:$POSTGRES_PASSWORD@postgres:5432/$POSTGRES_DB?sslmode=disable"
    DATABASE_VERSION: 17.5
    DATABASE_MAX_OPEN_CONNECTIONS: "180"
    DATABASE_MAX_IDLE_CONNECTIONS: "45"
    DATABASE_MAX_IDLE_TIME_MINS: "15"
    APP_ENV: develop
    APP_HOST: "http://localhost:3000"
    PORT: 8080
    LOG_LEVEL: info
    GO_VERSION: 1.24.5
    EMAILER_FAKED: "true"
    JOBCLIENT_MAX_WORKERS: "10"
    TOKEN_HMAC_KEY: "changeme-super-secret-key"
    TEMPLATES_PATH: "${CI_PROJECT_DIR}/backend/templates"
    SCHEMA_PATH: "${CI_PROJECT_DIR}/backend/schema"
    TEST_BYPASS_HEADER_NAME: "X-Test-Bypass"
    TEST_BYPASS_HEADER_VALUE: "test-bypass-secret"
    TEST_BASE_URL: "http://localhost:3000"
  image: mcr.microsoft.com/playwright:v1.52.0-noble
  stage: e2e
  interruptible: true
  services:
    - name: postgres:17.5-alpine
      alias: postgres
  dependencies:
    - build-frontend
  before_script:
    - apt-get update -qq && apt-get install -yqq postgresql-client
    - wget -q https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz
    - tar -C /usr/local -xzf go${GO_VERSION}.linux-amd64.tar.gz
    - export PATH="/usr/local/go/bin:${HOME}/go/bin:$PATH"
    - export GOPATH="${HOME}/go"
    - cd backend && go build -o playbymail-server ./cmd/server && cd ..
    - ./tools/db-migrate-up
    - ./tools/db-load-seed-reference-data
    - ./tools/db-load-seed-data
    - cd frontend && npm ci && cd ..
  script:
    - export PATH="/usr/local/go/bin:${HOME}/go/bin:$PATH"
    - cd backend && ./playbymail-server &
    - BACKEND_PID=$!
    - cd ..
    - cd frontend && npm run dev &
    - FRONTEND_PID=$!
    - cd ..
    - sleep 5
    - echo "Testing backend health endpoint..."
    - curl -v http://localhost:8080/healthz || echo "Health check failed"
    - npx wait-on http://localhost:8080/healthz http://localhost:3000 --timeout 60000
    - ./tools/test-e2e
  artifacts:
    when: on_failure
    paths:
      - test-results/
      - playwright/screenshots/
    expire_in: 7 days
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# Heroku Deployment Branch Workflow
#
# 1. Create a Deployment Branch from Backend Directory
#    - Use git subtree split to create a new branch (heroku-deploy) that
#      contains only the contents of the backend directory. This isolates the
#      backend code for deployment.
# 2. Switch to the Deployment Branch
#    - Move into the newly created heroku-deploy branch, which now acts as a
#      standalone copy of the backend codebase.
# 3. Add Frontend Build Artifacts
#    - Copy the necessary frontend build files (such as compiled JavaScript,
#      CSS, and other assets) into the heroku-deploy branch. This ensures the
#      backend deployment includes the latest frontend assets.
# 4. Build Required Binaries
#    - In the heroku-deploy branch, build any required binaries (such as
#      migrate and river). These binaries are needed for database migrations or
#      other backend tasks during deployment.
# 5. Push to Heroku
#    - Push the heroku-deploy branch to the Heroku remote repository. This
#      triggers the deployment process on Heroku, using only the prepared
#      backend (and included frontend assets).
# 6. Clean Up
#    - After deployment, delete the heroku-deploy branch to keep the repository
#      clean and avoid clutter from temporary deployment branches.

deploy-backend:
  image: golang:1.24.5-alpine
  stage: deploy
  interruptible: false # This job should not be interrupted
  dependencies:
    - build-frontend
  before_script:
    - apk add --no-cache git bash
    - apk add --no-cache git-subtree
    - cp -r frontend/dist /tmp/frontend-dist
    - echo "==== ENVIRONMENT ===="
    - printenv | sort
    - echo "==== GIT LOG ===="
    - git log --oneline -5
  script:
    - echo "==== SUBTREE SPLIT ===="
    - git config --global user.email "alienspaces@gmail.com"
    - git config --global user.name "Alien Spaces"
    - git subtree split --prefix backend -b heroku-deploy
    - git checkout heroku-deploy
    # Add frontend build artifacts to the deploy branch
    - cp -r /tmp/frontend-dist public
    - git add public
    - git commit -m "Add frontend build artifacts" || echo "No changes to commit"
    # Build migrate and river binaries in the deploy branch only
    - go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@v4.17.1
    - go install github.com/riverqueue/river/cmd/river@v0.23.1
    - mkdir -p bin
    - cp /go/bin/migrate bin/
    - cp /go/bin/river bin/
    - chmod +x bin/migrate bin/river
    - git add bin/migrate bin/river
    - git commit -m "Add migrate and river binaries for Heroku release phase" || echo "No changes to commit"
    - git checkout -
    - echo "==== PUSH TO HEROKU ===="
    - git push https://heroku:$HEROKU_API_KEY@git.heroku.com/$HEROKU_APP_NAME.git heroku-deploy:main --force
  only:
    - main
  environment:
    name: production
    url: https://$HEROKU_APP_NAME.herokuapp.com
